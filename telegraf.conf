# Telegraf Configuration - FINAL, CORRECTED VERSION using correct property names

[agent]
  interval = "10s"
  flush_interval = "10s"
#   logtarget = "file"
#   logfile = "/etc/telegraf/telegraf.log"

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "my-super-secret-token"
  organization = "my-pothole-org"
  bucket = "pothole_db"

# --- INPUT PLUGIN 1: deduplicated-pothole-events ---
[[inputs.kafka_consumer]]
  brokers = ["kafka:29092"]
  topics = ["deduplicated-pothole-events"]
  consumer_group = "telegraf_pothole_state_consumers"
  data_format = "json_v2"

  [[inputs.kafka_consumer.json_v2]]
    measurement_name = "pothole_state"
    # Use the correct property names for the v2 parser
    timestamp_path = "lastReportedTimestampMs"
    timestamp_format = "unix_ms"

    [[inputs.kafka_consumer.json_v2.tag]]
      path = "tags.locationId"
    [[inputs.kafka_consumer.json_v2.tag]]
      path = "tags.severityType"

    [[inputs.kafka_consumer.json_v2.field]]
      path = "currentSeverityValue"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "detectionCount"
      type = "integer"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "latitude"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "longitude"
      type = "float"

# --- INPUT PLUGIN 2: weekly_pothole_summary_stats ---
[[inputs.kafka_consumer]]
  brokers = ["kafka:29092"]
  topics = ["weekly_pothole_summary_stats"]
  consumer_group = "telegraf_weekly_stats_consumers"
  data_format = "json_v2"

  [[inputs.kafka_consumer.json_v2]]
    measurement_name = "pothole_weekly_summary"
    timestamp_path = "windowStartMs"
    timestamp_format = "unix_ms"

    [[inputs.kafka_consumer.json_v2.tag]]
      path = "tags.areaKey"
      rename = "areaKey"

    [[inputs.kafka_consumer.json_v2.field]]
      path = "totalPotholes"
      type = "integer"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "avgSeverity"
      type = "float"

# --- INPUT PLUGIN 3: pothole_severity_type_distribution_counts ---
[[inputs.kafka_consumer]]
  brokers = ["kafka:29092"]
  topics = ["pothole_severity_type_distribution_counts"]
  consumer_group = "telegraf_severity_dist_consumers"
  data_format = "json_v2"

  [[inputs.kafka_consumer.json_v2]]
    measurement_name = "pothole_severity_distribution"
    [[inputs.kafka_consumer.json_v2.tag]]
      path = "tags.severityType"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "count"
      type = "integer"

# --- INPUT PLUGIN 4: pothole-events (raw events) ---
[[inputs.kafka_consumer]]
  brokers = ["kafka:29092"]
  topics = ["pothole-events"]
  consumer_group = "telegraf_raw_event_consumers"
  data_format = "json_v2"

  [[inputs.kafka_consumer.json_v2]]
    measurement_name = "raw_pothole_event"
    timestamp_path = "event_timestamp"
    timestamp_format = "2006-01-02T15:04:05.999999999Z07:00"

    [[inputs.kafka_consumer.json_v2.tag]]
      path = "event_type"
    [[inputs.kafka_consumer.json_v2.tag]]
      path = "device_id"
    [[inputs.kafka_consumer.json_v2.tag]]
      path = "location_id"
    [[inputs.kafka_consumer.json_v2.tag]]
      path = "severity_type"

    [[inputs.kafka_consumer.json_v2.field]]
      path = "location_latitude"
      rename = "latitude"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "location_longitude"
      rename = "longitude"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "accelerometer_x"
      rename = "accel_x"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "accelerometer_y"
      rename = "accel_y"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "accelerometer_z"
      rename = "accel_z"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "severity"
      rename = "severity_float"
      type = "float"

# --- INPUT PLUGIN 5: unique_pothole_first_reports ---
[[inputs.kafka_consumer]]
  brokers = ["kafka:29092"]
  topics = ["unique_pothole_first_reports"]
  consumer_group = "telegraf_unique_report_consumers"
  data_format = "json_v2"

  [[inputs.kafka_consumer.json_v2]]
    measurement_name = "pothole_first_report"
    timestamp_path = "firstSeenTimestampMs"
    timestamp_format = "unix_ms"

    [[inputs.kafka_consumer.json_v2.tag]]
      path = "tags.locationId"
    [[inputs.kafka_consumer.json_v2.tag]]
      path = "tags.severityType"

    [[inputs.kafka_consumer.json_v2.field]]
      path = "latitude"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "longitude"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "detectionCount"
      type = "integer"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "currentSeverityValue"
      rename = "currentSeverityNumeric"
      type = "float"
    [[inputs.kafka_consumer.json_v2.field]]
      path = "lastReportedTimestampMs"
      type = "integer"